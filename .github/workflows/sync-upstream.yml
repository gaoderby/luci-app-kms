name: Sync Upstream Repositories

on:
  schedule:
    # æ¯å¤© UTC æ—¶é—´ 2 ç‚¹è‡ªåŠ¨åŒæ­¥ï¼ˆåŒ—äº¬æ—¶é—´ 10 ç‚¹ï¼‰
    - cron: '0 2 * * *'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
  push:
    branches: [ main ]

jobs:
  sync-upstream:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # å…è®¸æ¨é€ä»£ç 
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # è·å–å®Œæ•´å†å²
        
    - name: Setup Git
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        
    - name: Sync vlmcsd from upstream
      run: |
        echo "Syncing vlmcsd..."
        rm -rf /tmp/vlmcsd-upstream
        rm -rf package/network/vlmcsd
        
        git clone --depth=1 https://github.com/OneNAS-space/vlmcsd.git /tmp/vlmcsd-upstream
        mkdir -p package/network/vlmcsd
        cp -r /tmp/vlmcsd-upstream/* package/network/vlmcsd/ 2>/dev/null || true
        rm -rf /tmp/vlmcsd-upstream
        
    - name: Sync luci-app-vlmcsd from upstream
      run: |
        echo "Syncing luci-app-vlmcsd..."
        rm -rf /tmp/luci-vlmcsd-upstream
        rm -rf luci/applications/luci-app-vlmcsd
        
        git clone --depth=1 https://github.com/OneNAS-space/luci-app-vlmcsd.git /tmp/luci-vlmcsd-upstream
        mkdir -p luci/applications/luci-app-vlmcsd
        cp -r /tmp/luci-vlmcsd-upstream/* luci/applications/luci-app-vlmcsd/ 2>/dev/null || true
        rm -rf /tmp/luci-vlmcsd-upstream
        
    - name: Check for changes
      id: check-changes
      run: |
        git add .
        if git diff-index --quiet HEAD; then
          echo "changes=false" >> $GITHUB_OUTPUT
          echo "No changes detected"
        else
          echo "changes=true" >> $GITHUB_OUTPUT
          echo "Changes detected"
        fi
        
    - name: Commit and push changes
      if: steps.check-changes.outputs.changes == 'true'
      run: |
        git commit -m "ğŸ”„ è‡ªåŠ¨åŒæ­¥ä¸Šæ¸¸ä»“åº“: $(date +'%Y-%m-%d %H:%M:%S')"
        git push origin main
        echo "âœ… Changes committed and pushed"
        
    - name: Create sync tag
      if: steps.check-changes.outputs.changes == 'true'
      run: |
        SYNC_TAG="sync-$(date +'%Y%m%d-%H%M%S')"
        git tag -a "$SYNC_TAG" -m "è‡ªåŠ¨åŒæ­¥ç‚¹: $SYNC_TAG"
        git push origin "$SYNC_TAG"
